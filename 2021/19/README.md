I ended up using someone else's solution, I'm going to try to reimplement this another day.